metadata:
  name: "Disable Guest Attributes of Compute Engine metadata"
  id: "CCOE_GCP_DISABLE_GUEST_ATTRIBUTES"
  category: "security"
  severity: "HIGH"
  description: "Ensure guest attributes are disabled in VM instances."

definition:
   or:
      - or:
           - cond_type: "attribute"
             resource_types:
                - "google_compute_instance"
                - "google_compute_project_metadata"
             attribute: "metadata.enable-guest-attributes"
             operator: "not_exists"
           - cond_type: "attribute"
             resource_types:
                - "google_compute_instance"
                - "google_compute_project_metadata"
             attribute: "metadata.enable-guest-attributes"
             operator: "equals"
             value: false
      - or:
           - cond_type: "attribute"
             resource_types:
                - "google_compute_project_metadata_item"
             attribute: "key"
             operator: "not_equals"
             value: "enable-guest-attributes"
           - and:
                - cond_type: "attribute"
                  resource_types:
                     - "google_compute_project_metadata_item"
                  attribute: "key"
                  operator: "equals"
                  value: "enable-guest-attributes"
                - cond_type: "attribute"
                  resource_types:
                     - "google_compute_project_metadata_item"
                  attribute: "value"
                  operator: "equals"
                  value: false

# definition:
#   or:
#     - cond_type: "attribute"
#       resource_types:
#         - "google_compute_instance"
#         - "google_compute_project_metadata"
#       attribute: "metadata.enable-guest-attributes"
#       operator: "not_exists"
#     - cond_type: "attribute"
#       resource_types:
#         - "google_compute_instance"
#         - "google_compute_project_metadata"
#       attribute: "metadata.enable-guest-attributes"
#       operator: "equals"
#       value: false
#   or:
#     - cond_type: "attribute"
#       resource_types:
#         - "google_compute_project_metadata_item"
#       attribute: "key"
#       operator: "not_equals"
#       value: "enable-guest-attributes"
#     - and:
#          - cond_type: "attribute"
#            resource_types:
#              - "google_compute_project_metadata_item"
#             attribute: "key"
#             operator: "equals"
#             value: "enable-guest-attributes"
#           - cond_type: "attribute"
#             resource_types:
#               - "google_compute_project_metadata_item"
#             attribute: "value"
#             operator: "equals"
#             value: false
     
