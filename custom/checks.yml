metadata:
  name: "Disable IPv6 usage in GCP network resources"
  id: "CCOE_GCP_DISABLE_IPV6"
  category: "security"
  severity: "HIGH"
  description: "Ensure all IPv6 are disabled"
  
definition:
  or:
    - and:
        - or:
            - cond_type: "attribute"
              resource_types:
                - "google_compute_subnetwork"
              attribute: "stack_type"
              operator: "not_exists"
            - cond_type: "attribute"
              resource_types:
                - "google_compute_subnetwork"
              attribute: "stack_type"
              operator: "equals"
              value: "IPV4_ONLY"
        - or:
            - cond_type: "attribute"
              resource_types:
                - "google_compute_subnetwork"
              attribute: "ipv6_cidr_range"
              operator: "not_exists"
            - cond_type: "attribute"
              resource_types:
                - "google_compute_subnetwork"
              attribute: "ipv6_cidr_range"
              operator: "not_regex_match"
              value: "*:*"
        - or:
            - cond_type: "attribute"
              resource_types:
                - "google_compute_subnetwork"
              attribute: "ipv6_access_type"
              operator: "not_exists"
            - cond_type: "attribute"
              resource_types:
                - "google_compute_subnetwork"
              attribute: "ipv6_access_type"
              operator: "not_exists"
    - and:
        - or:
            - cond_type: "attribute"
              resource_types:
                - "google_compute_instance"
              attribute: "network_interface.stack_type"
              operator: "not_exists"
            - cond_type: "attribute"
              resource_types:
                - "google_compute_instance"
              attribute: "network_interface.stack_type"
              operator: "equals"
              value: "IPV4_ONLY"
        - or:
            - cond_type: "attribute"
              resource_types:
                - "google_compute_instance"
              attribute: "network_interface.ipv6_access_config"
              operator: "not_exists"
            - cond_type: "attribute"
              resource_types:
                - "google_compute_instance"
              attribute: "network_interface.ipv6_access_config"
              operator: "not_exists"
        - or:
            - cond_type: "attribute"
              resource_types:
                - "google_compute_instance"
              attribute: "network_interface.*.alias_ip_range.*.ip_cidr_range"
              operator: "not_exists"
            - cond_type: solver
              solver_type: attribute
              resource_types:
                - "google_compute_instance"
              attribute: "network_interface.*.alias_ip_range.*.ip_cidr_range"
              operator: "cidr_range_not_subset_attribute_solver"
              value: "0.0.0.0/0" # No IPv6 CIDRs allowed
    - and:
        - or:
            - cond_type: "attribute"
              resource_types:
                - "google_compute_network"
              attribute: "enable_ula_internal_ipv6"
              operator: "not_exists"
            - cond_type: "attribute"
              resource_types:
                - "google_compute_network"
              attribute: "enable_ula_internal_ipv6"
              operator: "not_equals"
              value: true
        - or:
            - cond_type: "attribute"
              resource_types:
                - "google_compute_network"
              attribute: "internal_ipv6_range"
              operator: "not_exists"
            - cond_type: "attribute"
              resource_types:
                - "google_compute_network"
              attribute: "internal_ipv6_range"
              operator: "not_exists"


